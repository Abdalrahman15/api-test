const express = require("express");
const mongoose = require("mongoose");
const Car = require("./models/user.js");

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3000; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù†ÙØ° Ù…Ù† Koyeb
const MONGO_URI = process.env.MONGO_URI; // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†

// âœ… Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function connectDB() {
    try {
        await mongoose.connect(MONGO_URI);
        console.log("âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");

        // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙ‚Ø·
        app.listen(PORT, () => {
            console.log(`ğŸš€ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ http://localhost:${PORT}`);
        });

    } catch (err) {
        console.error("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", err);
        process.exit(1);
    }
}

connectDB();

// âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
app.post("/user", async (req, res) => {
    try {
        const { name, pass } = req.body;
        const car = new Car({ name, pass });
        await car.save();
        res.json({ message: "âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­", user: car });
    } catch (err) {
        res.status(500).json({ error: "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„", details: err.message });
    }
});

// âœ… Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
app.get("/user", async (req, res) => {
    try {
        const users = await Car.find();
        res.json(users);
    } catch (err) {
        res.status(500).json({ error: "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", details: err.message });
    }
});
